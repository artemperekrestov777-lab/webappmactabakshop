#!/bin/bash

echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞
SERVER_USER="root"
SERVER_HOST="85.198.83.41"
SERVER_PATH="/var/www/mactabak-shop"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –¥–æ—Å—Ç—É–ø–∞
echo "üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
ssh -o ConnectTimeout=5 $SERVER_USER@$SERVER_HOST "echo 'SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'" || {
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    exit 1
}

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
./scripts/backup.sh

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤..."
tar -czf deploy.tar.gz \
    --exclude='node_modules' \
    --exclude='logs/*' \
    --exclude='data/qr/*' \
    --exclude='–ë—ç–∫–∞–ø/*' \
    --exclude='bot.lock' \
    --exclude='.git' \
    .

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp deploy.tar.gz $SERVER_USER@$SERVER_HOST:/tmp/

# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üõ†Ô∏è –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ..."
ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    mkdir -p /var/www/mactabak-shop
    cd /var/www/mactabak-shop

    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
    if [ -f "bot.lock" ]; then
        OLD_PID=$(cat bot.lock)
        kill $OLD_PID 2>/dev/null
        rm bot.lock
    fi

    # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
    tar -xzf /tmp/deploy.tar.gz
    rm /tmp/deploy.tar.gz

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    npm install --production

    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    mkdir -p logs data/qr webapp/images

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
    chmod +x scripts/*.sh

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –µ—Å–ª–∏ –Ω–µ—Ç
    npm list -g pm2 || npm install -g pm2

    # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
    pm2 delete mactabak-bot 2>/dev/null
    pm2 start bot/index.js --name mactabak-bot
    pm2 save
    pm2 startup

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx
    cat > /etc/nginx/sites-available/mactabak-shop << 'EOF'
server {
    listen 80;
    server_name _;

    location / {
        root /var/www/mactabak-shop/webapp;
        index index.html;
        try_files $uri $uri/ =404;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

    # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    ln -sf /etc/nginx/sites-available/mactabak-shop /etc/nginx/sites-enabled/
    nginx -t && systemctl reload nginx

    echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
ENDSSH

# –û—á–∏—Å—Ç–∫–∞
rm deploy.tar.gz

echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üì± –ë–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ Telegram"
echo "üåê WebApp –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://$SERVER_HOST"